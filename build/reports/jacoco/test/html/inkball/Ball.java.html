<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Ball.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">inkball_scaffold</a> &gt; <a href="index.source.html" class="el_package">inkball</a> &gt; <span class="el_source">Ball.java</span></div><h1>Ball.java</h1><pre class="source lang-java linenums">package inkball;

import processing.core.PImage;
import processing.core.PConstants;

import java.util.*;

import com.google.common.collect.Streams.DoubleFunctionWithIndex;
import com.jogamp.common.net.PiggybackURLConnection;

public class Ball implements Calculate{
    private String colour;
    private PImage sprite;
    private int x;
    private int y;
    private double xvel;
    private double yvel;
    private double xcoordinate;
    private double ycoordinate;
<span class="fc" id="L20">    private boolean onboard=false;</span>
<span class="fc" id="L21">    private boolean absorbed = false;</span>
    private int ballradius;
    private double xcentralcoordinate;
    private double ycentralcoordinate;

    /**
     * constructor of the ball, onboard, iscollided, absorbed is defaulted false.
     */
<span class="fc" id="L29">    public Ball(){</span>
<span class="fc" id="L30">        onboard=false;</span>
<span class="fc" id="L31">        absorbed = false; </span>
<span class="fc" id="L32">    }</span>
    /**
     * set velocity of this ball.
     */
    public void initializeVel(){
<span class="fc bfc" id="L37" title="All 2 branches covered.">        this.xvel = App.random.nextBoolean() ? 2 : -2;</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">        this.yvel = App.random.nextBoolean() ? 2 : -2;</span>
<span class="fc" id="L39">    }</span>
    /**
     * set passing Pimage as the sprite of this ball 
     * @param img a PImage
     */
    public void setSprite(PImage img){
<span class="fc" id="L45">        this.sprite = img;</span>
<span class="fc" id="L46">        ballradius = this.sprite.width/2;</span>

<span class="fc" id="L48">    }</span>
    /**
     * get this ball's sprite
     * @return sprite
     */
    public PImage getSprite(){
<span class="fc" id="L54">        return this.sprite;</span>
    }
    /**
     * set the color of this ball
     * @param s the color
     */
    public void setColour(String s){
<span class="fc" id="L61">        this.colour = s;</span>
<span class="fc" id="L62">    }</span>
    /**
     * get this ball colour
     * @return
     */
    public String getColour(){
<span class="fc" id="L68">        return this.colour;</span>
    }
    /**
     * set the coordinate of the ball on the board and the index in the array.
     * @param x 
     * @param y
     */
    public void setCoordinate(int x, int y){ 
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if(this.onboard){</span>
<span class="fc" id="L77">            this.x = x;</span>
<span class="fc" id="L78">            this.y = y;</span>
<span class="fc" id="L79">            xcoordinate = x*App.CELLSIZE;</span>
<span class="fc" id="L80">            ycoordinate = y*App.CELLSIZE+App.TOPBAR;            </span>
        }else{
<span class="fc" id="L82">            xcoordinate = x;</span>
<span class="fc" id="L83">            ycoordinate = y;</span>
        }
<span class="fc" id="L85">        xcentralcoordinate = xcoordinate + ballradius;</span>
        
<span class="fc" id="L87">        ycentralcoordinate = ycoordinate + ballradius;</span>

<span class="fc" id="L89">    }</span>
    /**
     * change the state of if it is displayed on the board,
     */
    public void setOnBoard(){
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if(onboard){</span>
<span class="nc" id="L95">            onboard = false;</span>
        }else{
<span class="fc" id="L97">            onboard = true;  </span>
        }
        
<span class="fc" id="L100">    }</span>
    /**
     * get boolean 'onboard'
     * @return onboard
     */
    public boolean getOnBoard(){
<span class="fc" id="L106">        return onboard;</span>
    }

    public void absorb(){
<span class="nc" id="L110">        absorbed = true;</span>
<span class="nc" id="L111">    }</span>
    /**
     * get state of absorbed
     * @return absorbed
     */
    public boolean absorption(){
<span class="fc" id="L117">        return absorbed;</span>
    }
    /**
     * pass app and 4 double value, to calculate which normal vector is we need then set the velocity.
     * @param app
     * @param a the first point x coordinate
     * @param b the first point y coordinate
     * @param c the second point x coordinate
     * @param d the second point y coordinate
     */
    public void calculateVel(App app, double a,double b, double c, double d){
<span class="fc" id="L128">        double[][] vecs = Calculate.getNormalVectors(a, b, c, d);</span>
<span class="fc" id="L129">        double[] midpoint = Calculate.getMidPoint(a, b, c, d);</span>
<span class="fc" id="L130">        double distancelineball1 = Calculate.getDistance(xcentralcoordinate, ycentralcoordinate, midpoint[0]+vecs[1][0], midpoint[1]+vecs[1][1]);</span>
<span class="fc" id="L131">        double distancelineball2 = Calculate.getDistance(xcentralcoordinate, ycentralcoordinate, midpoint[0]+vecs[1][0], midpoint[1]+vecs[1][1]);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if(distancelineball1&lt;distancelineball2){</span>
<span class="nc" id="L133">            vec = vecs[0];</span>
        }else{

<span class="fc" id="L136">            vec = vecs[1];</span>
        }
<span class="fc" id="L138">        this.setvel(vec);</span>

<span class="fc" id="L140">    }</span>
    /**
     * pass the app in it. check if the ball is collided with wall by get four point of the wall check the nearest points
     * then calculate the velocity.same logic with line.
     * @param app
     */
    double[] vec;
    public void checkCollision(App app){

        
<span class="fc bfc" id="L150" title="All 2 branches covered.">        for(Wall[] w : app.board){</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            for(Wall w1: w){</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">                if(w1.ifIsWall()){</span>
<span class="fc" id="L153">                    double ballradius = this.sprite.width/2;</span>
<span class="fc" id="L154">                    double xc = this.getXcoordinate() + ballradius + xvel;</span>
<span class="fc" id="L155">                    double yc = this.getYcoordinate() + ballradius + yvel;</span>
<span class="fc" id="L156">                    double[][] fourpointslist = w1.getPointCoordinate(app);</span>
<span class="fc" id="L157">                    double dtopleft = Calculate.getDistance(fourpointslist[0][0], fourpointslist[0][1], xc,yc);</span>
<span class="fc" id="L158">                    double dtopright = Calculate.getDistance(fourpointslist[1][0], fourpointslist[1][1], xc,yc);</span>
<span class="fc" id="L159">                    double dbottomright = Calculate.getDistance(fourpointslist[2][0], fourpointslist[2][1], xc,yc);</span>
<span class="fc" id="L160">                    double dbottomleft = Calculate.getDistance(fourpointslist[3][0], fourpointslist[3][1], xc,yc);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">                    boolean top = dtopleft +dtopright &lt;= App.CELLSIZE + ballradius;</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">                    boolean right = dtopright + dbottomright &lt;= App.CELLSIZE + ballradius;</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">                    boolean bottom = dbottomleft + dbottomright &lt;= App.CELLSIZE + ballradius;</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                    boolean left = dtopleft + dbottomleft &lt;= App.CELLSIZE + ballradius;</span>
                    //final vector;
<span class="fc bfc" id="L166" title="All 2 branches covered.">                    if(top){</span>
<span class="fc" id="L167">                        calculateVel(app, fourpointslist[0][0], fourpointslist[0][1], fourpointslist[1][0], fourpointslist[1][1]);</span>
            
<span class="fc bfc" id="L169" title="All 2 branches covered.">                    }else if(right){</span>
<span class="fc" id="L170">                        calculateVel(app, fourpointslist[2][0], fourpointslist[2][1], fourpointslist[1][0], fourpointslist[1][1]);</span>
                    
<span class="fc bfc" id="L172" title="All 2 branches covered.">                    }else if(bottom){</span>
<span class="fc" id="L173">                        calculateVel(app, fourpointslist[2][0], fourpointslist[2][1], fourpointslist[3][0], fourpointslist[3][1]);</span>
                        
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">                    }else if(left){</span>
<span class="nc" id="L176">                        calculateVel(app, fourpointslist[0][0], fourpointslist[0][1], fourpointslist[3][0], fourpointslist[3][1]);</span>
            
                    }

<span class="pc bpc" id="L180" title="1 of 8 branches missed.">                    if(top || right || bottom || left){</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">                        if(w1.getColour().equals(&quot;orange&quot;)){</span>
<span class="fc" id="L182">                            this.setColour(&quot;orange&quot;);</span>
<span class="fc" id="L183">                            this.setSprite(app.getSprite(&quot;ball1&quot;));</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">                        }else if(w1.getColour().equals(&quot;blue&quot;)){</span>
<span class="fc" id="L185">                            this.setColour(&quot;blue&quot;);</span>
<span class="fc" id="L186">                            this.setSprite(app.getSprite(&quot;ball2&quot;));</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">                        }else if(w1.getColour().equals(&quot;green&quot;)){</span>
<span class="nc" id="L188">                            this.setColour(&quot;green&quot;);</span>
<span class="nc" id="L189">                            this.setSprite(app.getSprite(&quot;ball3&quot;));</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">                        }else if(w1.getColour().equals(&quot;yellow&quot;)){</span>
<span class="fc" id="L191">                            this.setColour(&quot;yellow&quot;);</span>
<span class="fc" id="L192">                            this.setSprite(app.getSprite(&quot;ball4&quot;));</span>
                        }
                        
                    }                    
                }
            }
        }
        
        //line has been drawn but not be collided.
<span class="fc bfc" id="L201" title="All 2 branches covered.">        for(ArrayList&lt;Linesegment&gt; line : app.lines){</span>
<span class="fc" id="L202">            boolean eraseline = false;</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">            for(Linesegment l : line){</span>
                
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">                if(!l.getCollision()){</span>
<span class="fc" id="L206">                    double lsx =l.getstartx();</span>
<span class="fc" id="L207">                    double lsy =l.getstarty();</span>
<span class="fc" id="L208">                    double lex =l.getendx();</span>
<span class="fc" id="L209">                    double ley =l.getendy();</span>
<span class="fc" id="L210">                    double xc = this.getXcoordinate() + ballradius + xvel;</span>
<span class="fc" id="L211">                    double yc = this.getYcoordinate() + ballradius + yvel;</span>
                    
<span class="fc" id="L213">                    double d1 = Calculate.getDistance(xc,yc,lsx,lsy);</span>
<span class="fc" id="L214">                    double d2 = Calculate.getDistance(xc,yc,lex,ley);</span>
<span class="fc" id="L215">                    double d3 = Calculate.getDistance(lsx, lsy, lex, ley) + ballradius;</span>

<span class="pc bpc" id="L217" title="1 of 2 branches missed.">                    if((d1+d2)&lt;=d3){</span>
<span class="nc" id="L218">                        eraseline = true;</span>
<span class="nc" id="L219">                        calculateVel(app,l.getstartx(), l.getstarty(), l.getendx(), l.getendy());</span>
                    }
<span class="pc bpc" id="L221" title="3 of 4 branches missed.">                    if(app.mousePressed &amp;&amp; (app.mouseButton == App.RIGHT)){</span>
<span class="nc" id="L222">                        double d4 = Calculate.getDistance(app.mouseX, app.mouseY, lsx, lsy);</span>
<span class="nc" id="L223">                        double d5 = Calculate.getDistance(app.mouseX, app.mouseY, lex, ley);                        </span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                        if((d4+d5)&lt;= d3+20){</span>
<span class="nc" id="L225">                            eraseline = true;</span>
                        }   
                    }
   
                }
                
<span class="fc" id="L231">            }</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">            if(eraseline){</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                for(Linesegment l : line){</span>
<span class="nc" id="L234">                    l.collide();</span>
<span class="nc" id="L235">                }</span>
            
            }
<span class="fc" id="L238">        }</span>
        // line that is being drawn.
<span class="fc" id="L240">        boolean eraseCurrentLine = false;</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        for(Linesegment l : app.linesegments){</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">            if(!l.getCollision()){</span>
<span class="fc" id="L243">                ballradius = this.sprite.width/2;</span>
<span class="fc" id="L244">                double xc = this.getXcoordinate() + ballradius + xvel;//central coordinate of ball of next frame</span>
<span class="fc" id="L245">                double yc = this.getYcoordinate() + ballradius + yvel;                </span>
                
<span class="fc" id="L247">                double d1 = Calculate.getDistance(xc,yc,l.getstartx(), l.getstarty());</span>
<span class="fc" id="L248">                double d2 = Calculate.getDistance(xc,yc,l.getendx(), l.getendy());</span>
<span class="fc" id="L249">                double d3 = Calculate.getDistance(l.getstartx(), l.getstarty(), l.getendx(), l.getendy()) + ballradius;</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">                if((d1+d2)&lt;=d3){</span>
                    //this.collide();
<span class="nc" id="L252">                    eraseCurrentLine = true;</span>
<span class="nc" id="L253">                    calculateVel(app,l.getstartx(), l.getstarty(), l.getendx(), l.getendy());</span>
                }                
            }
<span class="fc" id="L256">        }</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">        if(eraseCurrentLine){</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            for(Linesegment l : app.linesegments){</span>
<span class="nc" id="L259">                l.collide();</span>
<span class="nc" id="L260">            }</span>
        }   
<span class="fc" id="L262">    }</span>
    /**
     * pass the app in this method, check whether the location of the ball is close to a hole and which hole
     * then calculate the socre 
     * @param app
     */
    public void checkAbsorption(App app){
<span class="fc" id="L269">        int ballradius = this.sprite.width/2;</span>
<span class="fc" id="L270">        double posx = this.xcoordinate +ballradius;</span>
<span class="fc" id="L271">        double posy = this.ycoordinate + ballradius +App.TOPBAR;</span>
        double targetx,targety;
<span class="fc" id="L273">        PImage img = app.getSprite(&quot;ball&quot;+app.colorsprites.get(this.colour)).copy();</span>
<span class="fc" id="L274">        int holewidth = app.getSprite(&quot;hole1&quot;).width/2;</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">        for(Hole h : app.holes){</span>
<span class="fc" id="L276">            targetx = h.getcenterXcoordinate(app);</span>
<span class="fc" id="L277">            targety = h.getcenterYcoordinate(app)+64;</span>
<span class="fc" id="L278">            double forcex = (targetx - posx)*0.03;</span>
<span class="fc" id="L279">            double forcey = (targety - posy)*0.03;</span>
<span class="fc" id="L280">            double d = Calculate.getDistance(posx,posy,targetx,targety);</span>
<span class="pc bpc" id="L281" title="1 of 4 branches missed.">            if (d&lt;=holewidth &amp;&amp; d&gt;0){</span>
<span class="fc" id="L282">                xvel += forcex;</span>
<span class="fc" id="L283">                yvel += forcey;</span>

<span class="pc bpc" id="L285" title="1 of 2 branches missed.">                if(d&lt;10){</span>
<span class="nc bnc" id="L286" title="All 6 branches missed.">                    if(h.getColor().equals(this.colour) || h.getColor().equals(&quot;grey&quot;) || this.colour.equals(&quot;grey&quot;)){</span>
<span class="nc" id="L287">                        app.getscore(this.colour, h.getColor());</span>
<span class="nc" id="L288">                        absorb();</span>
                    }else{
<span class="nc" id="L290">                        app.getscore(this.colour, h.getColor());</span>
<span class="nc" id="L291">                        setOnBoard();</span>
<span class="nc" id="L292">                        setSprite(app.getSprite(&quot;ball&quot;+app.colorsprites.get(colour)));</span>
<span class="nc" id="L293">                        initializeVel();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                        if(app.ballinbox.size()==0){</span>
<span class="nc" id="L295">                            setCoordinate(23, 20);</span>
                        }else{
<span class="nc" id="L297">                           setCoordinate((int)app.ballinbox.get(app.ballinbox.size()-1).getXcoordinate()+27, 23); </span>
                        }
<span class="nc" id="L299">                        app.ballinbox.add(this);</span>
                        // put the ball back to the list, wait to be spawned again.
                    }   
                }else{
<span class="fc" id="L303">                    img.resize((int)(d/holewidth*img.width),(int) (d/holewidth*img.height));</span>
<span class="fc" id="L304">                    setSprite(img);                    </span>
                }                
            }
                

<span class="fc" id="L309">        }</span>

<span class="fc" id="L311">    }</span>
    /**
     * check if the ball is on accelerated tile, if it is, accelerate ball's velosity
     * @param app
     */
    public void acceleration(App app){
<span class="fc bfc" id="L317" title="All 2 branches covered.">        for(Wall w : app.acceleratedtile){</span>
<span class="fc" id="L318">            int topline = w.getYcoordinate();</span>
<span class="fc" id="L319">            int bottomline = w.getYcoordinate() + w.getSprite().height;</span>
<span class="fc" id="L320">            int leftline = w.getXcoordinate();</span>
<span class="fc" id="L321">            int rightline = w.getXcoordinate() + w.getSprite().height;</span>

<span class="fc bfc" id="L323" title="All 2 branches covered.">            if(this.getXcoordinate() + ballradius &gt;= leftline &amp;&amp; </span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">            this.getXcoordinate() + ballradius &lt;= rightline &amp;&amp;</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">            this.getYcoordinate() + ballradius &gt;= topline &amp;&amp;</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">            this.getYcoordinate() + ballradius &lt;= bottomline){</span>
                
<span class="nc bnc" id="L328" title="All 2 branches missed.">                if(w.getAcceleratedDirection() == &quot;up&quot;){</span>
<span class="nc" id="L329">                    yvel -= 0.2;</span>
                    
<span class="nc bnc" id="L331" title="All 2 branches missed.">                }else if(w.getAcceleratedDirection() == &quot;down&quot;){</span>
<span class="nc" id="L332">                    yvel +=0.2;</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                }else if(w.getAcceleratedDirection() == &quot;left&quot;){</span>
<span class="nc" id="L334">                    xvel -=0.2;</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                }else if(w.getAcceleratedDirection() == &quot;right&quot;){</span>
<span class="nc" id="L336">                    xvel +=0.2;</span>
                }
            }
<span class="fc" id="L339">        }</span>
<span class="fc" id="L340">    }</span>
    /**
     * pass the normal vector of the line segment been collided with, calculate the velocity of the ball
     * @param n normal vector of the line
     */
   public void setvel(double[] n){ 
<span class="fc" id="L346">        double vn = xvel*n[0]+yvel*n[1];</span>
<span class="fc" id="L347">        xvel = xvel - 2*vn*n[0];</span>
<span class="fc" id="L348">        yvel = yvel - 2*vn*n[1];</span>
<span class="fc" id="L349">    }</span>
    /**
     * the movement of the ball on black bar on top when a ball was spawned.
     */
    public void setvelonbar(){
<span class="fc" id="L354">        xcoordinate -=1;</span>
<span class="fc" id="L355">    }</span>
    /**
     * get x index
     * @return x
     */
    public int getX(){
<span class="fc" id="L361">        return this.x;</span>
    }
    /** 
     * get y index
     * @return y
     */
    public int getY(){
<span class="nc" id="L368">        return this.y;</span>
    }
    /**
     * get X coordinate
     * @return 
     */
    public double getXcoordinate(){
<span class="fc" id="L375">        return this.xcoordinate;</span>
    }
    /**
     * get Y coordinate
     * @return
     */
    public double getYcoordinate(){
<span class="fc" id="L382">        return this.ycoordinate;</span>
    }
    public double getxvel(){
<span class="fc" id="L385">        return this.xvel;</span>
    }
    public double getyvel(){
<span class="fc" id="L388">        return this.yvel;</span>
    }
    /**
     * check absorption and collision them move the ball
     * @param app
     */
    public void tick(App app){
<span class="fc" id="L395">        checkAbsorption(app);</span>
<span class="fc" id="L396">        checkCollision(app);</span>
<span class="fc" id="L397">        acceleration(app);</span>
<span class="fc" id="L398">        xcoordinate +=xvel;</span>
<span class="fc" id="L399">        ycoordinate +=yvel;            </span>
<span class="fc" id="L400">    }</span>
    /**
     * draw the ball on board
     * @param app
     */
    public void draw(App app){
<span class="fc" id="L406">        tick(app);</span>
<span class="fc" id="L407">        app.image(this.sprite, (float)xcoordinate,(float)ycoordinate);</span>


<span class="fc" id="L410">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>